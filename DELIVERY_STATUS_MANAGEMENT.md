# Система управления статусами поставки

## Обзор

Система управления статусами поставки предназначена для отдела снабжения и позволяет отслеживать полный жизненный цикл поставки от планирования до приемки.

## Жизненный цикл поставки

### Статусы поставки

1. **PLANNED** (Запланирована)
   - Поставка создана в системе
   - Ожидает подтверждения от поставщика
   - Можно изменить на: CONFIRMED, CANCELLED

2. **CONFIRMED** (Подтверждена поставщиком)
   - Поставщик подтвердил поставку
   - Готов к отгрузке
   - Можно изменить на: IN_TRANSIT, CANCELLED

3. **IN_TRANSIT** (В пути)
   - Товар в пути к складу
   - Можно изменить на: ARRIVED, DELIVERED, CANCELLED

4. **ARRIVED** (Прибыла на склад)
   - Товар прибыл на склад
   - Ожидает разгрузки
   - Можно изменить на: DELIVERED, CANCELLED

5. **DELIVERED** (Доставлена)
   - Товар разгружен
   - Готов к приемке
   - Можно изменить на: ACCEPTED, REJECTED, PARTIALLY_ACCEPTED

6. **ACCEPTED** (Принята)
   - Товар принят без замечаний
   - Финальный статус

7. **REJECTED** (Отклонена)
   - Товар отклонен по качеству или количеству
   - Финальный статус

8. **PARTIALLY_ACCEPTED** (Частично принята)
   - Часть товара принята, часть отклонена
   - Финальный статус

9. **CANCELLED** (Отменена)
   - Поставка отменена
   - Финальный статус

## Функциональность

### Управление статусами

#### В списке поставок
- Кнопка "Управление статусом" (иконка настроек) в каждой строке
- Открывает диалог с возможностью изменения статуса
- Показывает доступные переходы для текущего статуса

#### В деталях поставки
- Кнопка "Управление статусом" в заголовке страницы
- Полная схема жизненного цикла с описанием каждого этапа
- История изменений статуса с комментариями

### Комментарии к изменениям

- При изменении статуса можно добавить комментарий
- Комментарии сохраняются в поле `notes` с временной меткой
- Формат: `[dd.MM.yyyy HH:mm] Статус изменен на 'STATUS'. Комментарий: текст`

### Валидация переходов

Система контролирует допустимые переходы между статусами:

```
PLANNED → CONFIRMED, CANCELLED
CONFIRMED → IN_TRANSIT, CANCELLED
IN_TRANSIT → ARRIVED, DELIVERED, CANCELLED
ARRIVED → DELIVERED, CANCELLED
DELIVERED → ACCEPTED, REJECTED, PARTIALLY_ACCEPTED
ACCEPTED → (финальный)
REJECTED → (финальный)
PARTIALLY_ACCEPTED → (финальный)
CANCELLED → (финальный)
```

## API

### Изменение статуса поставки

```
PATCH /api/deliveries/{id}/status
Content-Type: application/json

{
  "status": "NEW_STATUS",
  "comment": "Комментарий к изменению"
}
```

### Ответ

```json
{
  "id": "uuid",
  "deliveryNumber": "DEL-001",
  "status": "NEW_STATUS",
  "notes": "Предыдущие заметки\n[01.01.2024 10:30] Статус изменен на 'NEW_STATUS'. Комментарий: текст",
  ...
}
```

## Интерфейс

### Компонент DeliveryStatusManager

- Диалог с выбором нового статуса
- Поле для комментария
- Схема жизненного цикла с описанием этапов
- Валидация доступных переходов
- Визуальные индикаторы статусов (цвета, иконки)

### Интеграция

- В списке поставок: кнопка в каждой строке
- В деталях поставки: кнопка в заголовке
- Автоматическое обновление данных после изменения

## Преимущества для отдела снабжения

1. **Прозрачность процесса** - четкий жизненный цикл поставки
2. **Контроль качества** - обязательные комментарии при изменениях
3. **История изменений** - полная аудитория изменений статуса
4. **Валидация** - предотвращение некорректных переходов
5. **Удобство** - управление статусами из любого места системы
6. **Аналитика** - статистика по статусам поставок

## Статистика

На главной странице поставок отображается статистика:
- Всего поставок
- Запланированные
- В пути
- Прибыли
- Приняты

## Техническая реализация

### Backend
- Enum `DeliveryStatus` с новыми статусами
- Метод `changeDeliveryStatus` с поддержкой комментариев
- Валидация переходов в сервисе
- Сохранение истории в поле `notes`

### Frontend
- Компонент `DeliveryStatusManager`
- Интеграция в список и детали поставки
- Визуальные индикаторы статусов
- Схема жизненного цикла

### База данных
- Индексы для быстрого поиска по статусу
- Поле для истории изменений
- Миграция V049 для новых статусов 