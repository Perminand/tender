# Создание типов доставки на лету

## Описание

Реализована функциональность создания типов доставки на лету на странице подачи предложения, аналогично тому, как это работает для поля "проект" в заявке.

## Что было реализовано

### 1. Модификация компонента DeliveryConditionForm

Компонент `frontend/src/components/DeliveryConditionForm.tsx` был модифицирован для поддержки создания типов доставки на лету:

- **Замена Select на Autocomplete**: Поле выбора типа доставки теперь использует Autocomplete вместо простого Select
- **Загрузка типов доставки**: Компонент загружает существующие типы доставки через API
- **Создание новых типов**: При вводе несуществующего типа появляется опция "Создать [название]"
- **Диалог создания**: При выборе создания нового типа открывается диалог для ввода названия
- **Обратная совместимость**: Поддержка старых хардкодных значений для обеспечения совместимости
- **Очистка структуры**: Удалены поля "Стоимость доставки" и "Адрес доставки" из условий доставки
- **Расширение модели Warehouse**: Добавлено поле address для хранения адреса склада
- **Централизация адреса доставки**: Адрес доставки теперь берется из склада тендера

### 2. Функциональность

#### Основные возможности:
- **Поиск по названию**: Автоматический поиск при вводе текста
- **Создание на лету**: Возможность создать новый тип доставки прямо из формы
- **Валидация**: Проверка на пустые значения и дублирование
- **Обработка ошибок**: Информативные сообщения об ошибках
- **Условия доставки**: Управление только условиями доставки (тип, срок, ответственность, дополнительные условия)
- **Разделение ответственности**: Поле "Стоимость доставки" перенесено в основное предложение, адрес доставки берется из склада тендера

#### Пользовательский интерфейс:
- **Autocomplete с поиском**: Удобный поиск по существующим типам
- **Опция создания**: Выделенная опция "Создать [название]" для новых типов
- **Модальный диалог**: Простой диалог для ввода названия нового типа
- **Клавиатурная навигация**: Поддержка Enter для создания и Escape для отмены

### 3. API интеграция

Используется существующий API для типов доставки:
- `GET /api/delivery-types` - получение всех типов доставки
- `POST /api/delivery-types` - создание нового типа доставки
- `DELETE /api/delivery-types/{id}` - удаление типа доставки

### 4. Обратная совместимость

Для обеспечения совместимости с существующими данными:
- Сохранены все старые хардкодные значения типов доставки
- При загрузке API типы объединяются с legacy типами
- В случае ошибки API используются только legacy типы

## Как использовать

### Для пользователей:

1. **Откройте страницу подачи предложения**
2. **Перейдите к разделу "Условия доставки"**
3. **В поле "Тип доставки" начните вводить название**
4. **Если нужного типа нет, выберите "Создать [название]"**
5. **В открывшемся диалоге введите название нового типа**
6. **Нажмите "Создать" или Enter**
7. **Заполните остальные поля условий доставки (срок, ответственность, дополнительные условия)**
8. **Стоимость доставки указывается в основном предложении, адрес доставки берется из склада тендера**

### Для разработчиков:

#### Структура компонента:

```typescript
interface DeliveryType {
  id: string;
  name: string;
}

interface DeliveryCondition {
  id?: string;
  name: string;
  description?: string;
  deliveryType: string;
  deliveryPeriod?: string;
  deliveryResponsibility: string;
  additionalTerms?: string;
  createdAt?: string;
  updatedAt?: string;
}
```

#### Основные функции:

```typescript
// Загрузка типов доставки
const loadDeliveryTypes = async () => {
  // Загружает типы из API и объединяет с legacy типами
};

// Обработка изменения типа доставки
const handleDeliveryTypeChange = (_, value: DeliveryType | null) => {
  // Обрабатывает выбор существующего или создание нового типа
};

// Создание нового типа доставки
const handleCreateDeliveryType = async () => {
  // Создает новый тип через API
};
```

## Тестирование

Для тестирования API типов доставки создан файл `test_delivery_types.html`:

1. **Запустите бэкенд** на порту 8080
2. **Откройте файл** `test_delivery_types.html` в браузере
3. **Протестируйте** создание, получение и удаление типов доставки

## Файлы, которые были изменены

1. **`frontend/src/components/DeliveryConditionForm.tsx`** - основной компонент с новой функциональностью
2. **`frontend/src/pages/ProposalEditPage.tsx`** - добавлена загрузка информации о тендере для получения адреса склада
3. **`src/main/java/ru/perminov/tender/model/Warehouse.java`** - добавлено поле address
4. **`src/main/java/ru/perminov/tender/dto/WarehouseDto.java`** - добавлено поле address в DTO
5. **`src/main/resources/db/changelog/changes/V075_add_address_to_warehouses.sql`** - миграция для добавления поля address
6. **`src/main/resources/db/changelog/db.changelog-master.yaml`** - добавлена новая миграция
7. **`test_delivery_types.html`** - тестовый файл для API
8. **`DELIVERY_TYPES_ON_THE_FLY_README.md`** - данная документация

## Преимущества реализации

1. **Удобство использования**: Пользователи могут создавать типы доставки прямо в процессе заполнения формы
2. **Гибкость**: Неограниченное количество пользовательских типов доставки
3. **Совместимость**: Работает с существующими данными и API
4. **UX**: Интуитивный интерфейс с поиском и автодополнением
5. **Надежность**: Обработка ошибок и валидация данных
6. **Правильная архитектура**: Разделение ответственности - условия доставки содержат только условия, а не конкретные данные
7. **Чистота данных**: Условия доставки теперь содержат только регламентирующую информацию
8. **Централизованный адрес**: Адрес доставки берется из склада тендера, что обеспечивает консистентность данных

## Аналогия с полем "проект"

Реализация полностью аналогична тому, как работает создание проектов на лету в `RequestEditPage`:

- Тот же паттерн с `CREATE_NEW` ID
- Аналогичный диалог создания
- Похожая логика обработки и валидации
- Схожий пользовательский интерфейс

Это обеспечивает консистентность пользовательского опыта во всем приложении.
