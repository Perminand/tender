# Управление счетами от поставщиков

## Обзор

В систему добавлена функциональность для управления счетами от поставщиков-победителей тендеров. Счета являются важным элементом процесса закупок, связывающим тендеры, контракты и платежи.

## Основные возможности

### 1. Создание и управление счетами
- Создание счетов от поставщиков-победителей тендеров
- Привязка счетов к заявкам, контрактам и поставщикам
- Управление статусами счетов
- Отслеживание оплат и остатков

### 2. Статусы счетов
- **DRAFT** - Черновик (создан, но не отправлен)
- **SENT** - Отправлен поставщиком
- **CONFIRMED** - Подтвержден заказчиком
- **PARTIALLY_PAID** - Частично оплачен
- **PAID** - Полностью оплачен
- **OVERDUE** - Просрочен
- **CANCELLED** - Отменен

### 3. Финансовое управление
- Отслеживание общей суммы счета
- Учет НДС
- Контроль оплаченных сумм
- Расчет остатков к оплате
- Поддержка различных валют

## Структура данных

### Модель Invoice
```java
@Entity
@Table(name = "invoices")
public class Invoice {
    private UUID id;
    private Contract contract;           // Связанный контракт
    private Company supplier;            // Поставщик
    private Request request;             // Связанная заявка
    private String invoiceNumber;        // Номер счета
    private LocalDate invoiceDate;       // Дата счета
    private LocalDate dueDate;           // Срок оплаты
    private LocalDate paymentDate;       // Дата оплаты
    private InvoiceStatus status;        // Статус счета
    private BigDecimal totalAmount;      // Общая сумма
    private BigDecimal paidAmount;       // Оплаченная сумма
    private BigDecimal vatAmount;        // Сумма НДС
    private String currency;             // Валюта
    private String paymentTerms;         // Условия оплаты
    private String notes;                // Примечания
    private List<InvoiceItem> invoiceItems; // Элементы счета
}
```

### Модель InvoiceItem
```java
@Entity
@Table(name = "invoice_items")
public class InvoiceItem {
    private UUID id;
    private Invoice invoice;             // Связанный счет
    private Material material;           // Материал
    private String description;          // Описание
    private BigDecimal quantity;         // Количество
    private Unit unit;                   // Единица измерения
    private BigDecimal unitPrice;        // Цена за единицу
    private BigDecimal totalPrice;       // Общая стоимость
    private BigDecimal vatRate;          // Ставка НДС
    private BigDecimal vatAmount;        // Сумма НДС
    private String notes;                // Примечания
}
```

## API Endpoints

### Основные операции со счетами

#### Создание счета
```http
POST /api/invoices
Content-Type: application/json

{
  "contractId": "uuid",
  "supplierId": "uuid",
  "requestId": "uuid",
  "invoiceNumber": "INV-2024-001",
  "invoiceDate": "2024-01-15",
  "dueDate": "2024-02-15",
  "totalAmount": 100000.00,
  "vatAmount": 20000.00,
  "currency": "RUB",
  "paymentTerms": "Оплата в течение 30 дней",
  "notes": "Дополнительная информация",
  "invoiceItems": [
    {
      "materialId": "uuid",
      "description": "Описание товара",
      "quantity": 10.0,
      "unitId": "uuid",
      "unitPrice": 10000.00,
      "vatRate": 20.0,
      "notes": "Примечания к позиции"
    }
  ]
}
```

#### Получение счетов
```http
GET /api/invoices                    # Все счета
GET /api/invoices/{id}               # Счет по ID
GET /api/invoices/request/{requestId} # Счета по заявке
GET /api/invoices/contract/{contractId} # Счета по контракту
GET /api/invoices/supplier/{supplierId} # Счета по поставщику
GET /api/invoices/status/{status}    # Счета по статусу
```

#### Обновление счета
```http
PUT /api/invoices/{id}
Content-Type: application/json

{
  "invoiceNumber": "INV-2024-001-REV",
  "totalAmount": 110000.00,
  "notes": "Обновленная информация"
}
```

#### Удаление счета
```http
DELETE /api/invoices/{id}
```

### Операции со статусами

#### Подтверждение счета
```http
POST /api/invoices/{id}/confirm
```

#### Оплата счета
```http
POST /api/invoices/{id}/pay?amount=50000.00
```

#### Отмена счета
```http
POST /api/invoices/{id}/cancel
```

### Специальные запросы

#### Просроченные счета
```http
GET /api/invoices/overdue
```

#### Счета ожидающие оплаты
```http
GET /api/invoices/pending-payment
```

## Интерфейс пользователя

### Страница управления счетами (/invoices)

Основные функции:
- **Просмотр всех счетов** в табличном виде
- **Фильтрация по статусам** счетов
- **Создание новых счетов** через диалоговое окно
- **Редактирование существующих** счетов
- **Управление статусами** (подтверждение, оплата, отмена)
- **Удаление счетов** (только черновики)

### Интеграция с процессами заявок

На странице "Процессы заявок" счета отображаются как часть общего процесса:
- Счета связаны с конкретными заявками
- Отображается статус оплаты
- Показывается связь с поставками и УПД
- Интегрированы с финансовыми показателями

## Бизнес-логика

### Жизненный цикл счета

1. **Создание** - Счет создается в статусе DRAFT
2. **Подтверждение** - Заказчик подтверждает счет (CONFIRMED)
3. **Оплата** - Производится оплата (PARTIALLY_PAID или PAID)
4. **Завершение** - Счет полностью оплачен или отменен

### Правила валидации

- Нельзя отменить полностью оплаченный счет
- Сумма оплаты не может превышать оставшуюся сумму
- Можно подтверждать только черновики счетов
- Счет автоматически становится просроченным при превышении срока оплаты

### Автоматические расчеты

- **Остаток к оплате** = Общая сумма - Оплаченная сумма
- **НДС по позиции** = (Количество × Цена за единицу) × Ставка НДС / 100
- **Общая стоимость позиции** = Количество × Цена за единицу

## Интеграция с другими модулями

### Связь с тендерами
- Счета создаются для поставщиков-победителей тендеров
- Связаны с конкретными предложениями

### Связь с контрактами
- Счета привязаны к контрактам
- Влияют на финансовые показатели контрактов

### Связь с поставками
- По счетам производятся поставки
- УПД привязаны к счетам

### Связь с платежами
- Платежи связаны со счетами
- Автоматическое обновление статусов при оплате

## Безопасность

### Права доступа
- **ROLE_ADMIN, ROLE_MANAGER** - Полный доступ к управлению счетами
- **ROLE_VIEWER** - Просмотр счетов
- **ROLE_CUSTOMER** - Просмотр счетов по своим заявкам

### Аудит
- Все операции со счетами логируются
- Отслеживаются изменения статусов
- Фиксируются суммы и даты операций

## Мониторинг и отчетность

### Ключевые показатели
- Общее количество счетов
- Сумма всех счетов
- Количество просроченных счетов
- Средний срок оплаты
- Процент оплаченных счетов

### Уведомления
- Уведомления о просроченных счетах
- Напоминания о приближающихся сроках оплаты
- Уведомления о новых счетах

## Техническая реализация

### Backend
- **Controller**: `InvoiceController` - REST API для управления счетами
- **Service**: `InvoiceService` - бизнес-логика
- **Repository**: `InvoiceRepository` - доступ к данным
- **DTO**: `InvoiceDto`, `InvoiceDtoNew`, `InvoiceDtoUpdate` - передача данных

### Frontend
- **Page**: `InvoiceManagementPage` - основная страница управления
- **Components**: Интеграция с `RequestProcessMatryoshka`
- **Types**: Обновленные типы в `requestProcess.ts`

### База данных
- Таблица `invoices` - основная информация о счетах
- Таблица `invoice_items` - позиции счетов
- Связи с таблицами `contracts`, `companies`, `requests`

## Планы развития

### Краткосрочные планы
- Добавление массовых операций со счетами
- Интеграция с внешними системами учета
- Расширенная отчетность по счетам

### Долгосрочные планы
- Автоматическое создание счетов на основе контрактов
- Интеграция с банковскими системами
- Мобильное приложение для управления счетами 