# Настройка почтового сервера для системы тендеров

## Обзор

Для тестирования email уведомлений в системе тендеров используется MailHog - это инструмент для перехвата и просмотра email сообщений в разработке.

## Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   MailHog       │
│   (React)       │◄──►│   (Spring Boot) │───►│   (SMTP Server) │
│   Port: 5173    │    │   Port: 8080    │    │   Port: 1025    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
                                              ┌─────────────────┐
                                              │   MailHog UI    │
                                              │   Port: 8025    │
                                              └─────────────────┘
```

## Запуск с Docker Compose

### 1. Запуск всех сервисов

```bash
docker-compose up -d
```

Это запустит:
- **PostgreSQL** (порт 5432) - база данных
- **Backend** (порт 8080) - Spring Boot приложение
- **MailHog** (порт 1025) - SMTP сервер
- **MailHog UI** (порт 8025) - веб-интерфейс для просмотра писем

### 2. Проверка работы

1. **Backend API**: http://localhost:8080
2. **MailHog UI**: http://localhost:8025
3. **Frontend**: http://localhost:5173 (запускается отдельно)

### 3. Настройка email в веб-интерфейсе

1. Откройте http://localhost:5173
2. Перейдите в "Настройки"
3. В разделе "Настройки Email уведомлений":

#### Автоматическая настройка (рекомендуется):
1. Выберите "MailHog (Development)" из выпадающего списка провайдеров
2. Или просто введите email в поле "Email пользователя" - система автоматически определит провайдера
3. Настройки SMTP заполнятся автоматически
4. Нажмите "Сохранить настройки email"
5. Нажмите "Тестировать соединение" для проверки

#### Ручная настройка:
- **SMTP хост**: `localhost`
- **SMTP порт**: `1025`
- **Email пользователя**: (оставьте пустым)
- **Пароль**: (оставьте пустым)
- **Email отправителя**: `noreply@tender.local`
- **Имя отправителя**: `Система тендеров`
- **Включено**: ✓
- **SSL**: ✗
- **TLS**: ✗

## Тестирование email функциональности

### 1. Создание тендера

1. Создайте тендер в системе
2. При создании тендера система отправит уведомление
3. Проверьте MailHog UI: http://localhost:8025

### 2. Отправка предложений

1. Создайте предложение поставщика
2. Система отправит уведомление о новом предложении
3. Проверьте MailHog UI

### 3. Изменение статуса тендера

1. Измените статус тендера (опубликован, отменен, завершен)
2. Система отправит соответствующие уведомления
3. Проверьте MailHog UI

## Автоопределение провайдеров

Система поддерживает автоматическое определение настроек для популярных email провайдеров:

### Поддерживаемые провайдеры:
- **Gmail** - Google Gmail
- **Yandex** - Яндекс Почта  
- **Mail.ru** - Mail.ru, Inbox.ru, Bk.ru
- **Outlook/Hotmail** - Microsoft Outlook
- **Yahoo** - Yahoo Mail
- **MailHog** - для разработки и тестирования
- **Custom SMTP** - произвольный SMTP сервер

### Как работает автоопределение:
1. Введите email в поле "Email пользователя"
2. Система автоматически определит провайдера по домену
3. Настройки SMTP заполнятся автоматически
4. Выберите провайдера вручную для переопределения

### Инструкции для провайдеров:
- Система показывает пошаговые инструкции для каждого провайдера
- Нажмите "Показать инструкции" для получения детальной информации
- Следуйте инструкциям для настройки двухфакторной аутентификации

## Конфигурация для продакшена

Для продакшена замените MailHog на реальный SMTP сервер:

### Gmail (рекомендуется для тестирования)

```yaml
# В настройках системы:
SMTP хост: smtp.gmail.com
SMTP порт: 587
Email пользователя: your-email@gmail.com
Пароль: your-app-password
Email отправителя: your-email@gmail.com
Имя отправителя: Система тендеров
Включено: ✓
SSL: ✗
TLS: ✓
```

### Yandex

```yaml
SMTP хост: smtp.yandex.ru
SMTP порт: 465
Email пользователя: your-email@yandex.ru
Пароль: your-app-password
Email отправителя: your-email@yandex.ru
Имя отправителя: Система тендеров
Включено: ✓
SSL: ✓
TLS: ✗
```

### Корпоративный SMTP

```yaml
SMTP хост: smtp.yourcompany.com
SMTP порт: 587
Email пользователя: noreply@yourcompany.com
Пароль: your-smtp-password
Email отправителя: noreply@yourcompany.com
Имя отправителя: Система тендеров
Включено: ✓
SSL: ✗
TLS: ✓
```

## Получение App Password для Gmail

1. Включите двухфакторную аутентификацию в Google аккаунте
2. Перейдите в настройки безопасности
3. Найдите "Пароли приложений"
4. Создайте новый пароль для "Почта"
5. Используйте этот пароль в настройках SMTP

## Устранение неполадок

### Проблема: "Соединение с SMTP сервером не установлено"

**Решение:**
1. Проверьте, что MailHog запущен: `docker ps`
2. Проверьте порты: `netstat -an | grep 1025`
3. Перезапустите контейнеры: `docker-compose restart`

### Проблема: "Email не отправляется"

**Решение:**
1. Проверьте настройки в веб-интерфейсе
2. Убедитесь, что email включен в настройках
3. Проверьте логи backend: `docker logs tender-backend`

### Проблема: "Письма не отображаются в MailHog"

**Решение:**
1. Проверьте, что backend отправляет на правильный хост
2. Убедитесь, что MailHog доступен по адресу `mailhog:1025`
3. Проверьте сетевые настройки Docker

## Полезные команды

```bash
# Запуск всех сервисов
docker-compose up -d

# Просмотр логов
docker-compose logs -f

# Остановка всех сервисов
docker-compose down

# Перезапуск конкретного сервиса
docker-compose restart backend

# Просмотр логов конкретного сервиса
docker-compose logs -f backend

# Проверка статуса контейнеров
docker ps

# Очистка всех данных
docker-compose down -v
```

## Структура проекта

```
Tender/
├── docker-compose.yml          # Конфигурация Docker
├── Dockerfile                  # Образ для backend
├── .dockerignore              # Исключения для Docker
├── src/main/resources/
│   └── application.yml        # Конфигурация Spring Boot
└── MAIL_SETUP.md             # Эта документация
```

## Безопасность

⚠️ **Важно:** MailHog предназначен только для разработки и тестирования. 
Не используйте его в продакшене!

Для продакшена:
1. Используйте реальный SMTP сервер
2. Настройте SSL/TLS шифрование
3. Используйте сильные пароли
4. Настройте аутентификацию SMTP
5. Ограничьте доступ к SMTP серверу 