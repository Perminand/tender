# Функционал генерации Excel-отчетов

## Описание

Добавлен новый функционал для генерации Excel-отчетов по тендерам на странице "процессы заявок" в режиме "Матрешка". Отчет создается в формате Excel (.xlsx) и содержит структурированную информацию о тендерах, поставщиках и их предложениях.

## Структура отчета

Отчет включает следующие разделы:

### 1. Заголовок
- Название отчета с указанием проекта заявки

### 2. Информация о поставщиках
- Название поставщика
- Комментарий (пока не заполняется)
- Контактное лицо
- Телефон
- Сайт (пока не заполняется)

### 3. Основная таблица материалов
- п/н (порядковый номер)
- Наименование по заявке
- Количество
- Единица измерения
- **Строка информации о поставщиках** (название, контактное лицо, телефон)
- Для каждого поставщика:
  - Срок поставки (дни)
  - Стоимость с НДС (руб.)

### 4. Группировка материалов
Материалы автоматически группируются по категориям:
- **Тендер Доска** - доски и брусы
- **Тендер Брусок Термо** - термообработанные бруски
- **Тендер Имитация бруса** - имитация бруса
- **Тендер Материалы для фасада** - утеплители, антисептики, пленки, крепеж
- **Тендер Прочие материалы** - остальные материалы

### 5. Итоги
- Общая стоимость по каждому поставщику

## Форматирование

Отчет использует следующие стили:
- **Заголовки** - серый фон, жирный шрифт
- **Поставщики** - светло-зеленый фон для выделения
- **Итоги** - светло-зеленый фон, жирный шрифт
- **Данные** - стандартное форматирование с границами

## Как использовать

### На фронтенде
1. Перейдите на страницу "процессы заявок"
2. Убедитесь, что выбран режим просмотра "Матрешка"
3. В каждой заявке найдите кнопку "Excel" рядом с кнопкой "Просмотр"
4. Нажмите на кнопку "Excel" для скачивания отчета

### API Endpoint
```
GET /api/reports/tender/{requestId}
```

**Параметры:**
- `requestId` - UUID заявки

**Ответ:**
- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- Content-Disposition: `attachment; filename="Тендерная_таблица_заявка_{номер}_{проект}.xlsx"`

## Техническая реализация

### Backend компоненты

#### 1. ExcelReportService
- **Файл:** `src/main/java/ru/perminov/tender/service/ExcelReportService.java`
- **Назначение:** Основной сервис для генерации Excel-отчетов
- **Зависимости:** Apache POI для работы с Excel

#### 2. ExcelReportController
- **Файл:** `src/main/java/ru/perminov/tender/controller/ExcelReportController.java`
- **Назначение:** REST контроллер для обработки запросов на генерацию отчетов

#### 3. Обновленные DTO
- **Файл:** `src/main/java/ru/perminov/tender/dto/RequestProcessDto.java`
- **Изменения:** Добавлен класс `ProposalItemDto` для элементов предложений

#### 4. Обновленный RequestProcessService
- **Файл:** `src/main/java/ru/perminov/tender/service/RequestProcessService.java`
- **Изменения:** Добавлен метод `mapProposalItemToDto` для маппинга элементов предложений

### Frontend компоненты

#### 1. RequestProcessMatryoshka
- **Файл:** `frontend/src/components/RequestProcessMatryoshka.tsx`
- **Изменения:** 
  - Добавлена иконка `FileDownloadIcon`
  - Добавлена кнопка "Excel" с зеленым цветом
  - Добавлена функция `handleDownloadExcelReport`

## Зависимости

### Backend
```xml
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi</artifactId>
    <version>5.2.3</version>
</dependency>
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi-ooxml</artifactId>
    <version>5.2.3</version>
</dependency>
```

### Frontend
```typescript
import { FileDownload as FileDownloadIcon } from '@mui/icons-material';
```

## Логирование

Сервис включает подробное логирование:
- Начало генерации отчета
- Успешное завершение с размером файла
- Ошибки при генерации
- Предупреждения о недоступности данных поставщиков

## Обработка ошибок

- Если поставщик не найден в базе данных, его данные заполняются частично
- Если контактные лица отсутствуют, соответствующие поля остаются пустыми
- При ошибках генерации возвращается HTTP 500
- Эндпоинт `/api/reports/**` добавлен в конфигурацию безопасности для ролей ADMIN, MANAGER и VIEWER

## Расширение функционала

Для добавления новых полей в отчет:

1. Обновите DTO в `RequestProcessDto.java`
2. Добавьте маппинг в `RequestProcessService.java`
3. Обновите логику в `ExcelReportService.java`
4. При необходимости обновите фронтенд

## Пример использования

```javascript
// Скачивание отчета
const handleDownloadExcelReport = async (requestId) => {
  try {
    const response = await fetch(`/api/reports/tender/${requestId}`);
    if (!response.ok) throw new Error('Ошибка при загрузке отчета');
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Тендерная_таблица_заявка_${requestNumber}.xlsx`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (error) {
    console.error('Ошибка при скачивании отчета:', error);
    alert('Ошибка при скачивании отчета');
  }
};
```

## Заключение

Функционал генерации Excel-отчетов полностью интегрирован в существующую систему и готов к использованию. Отчеты создаются в соответствии с требованиями и содержат всю необходимую информацию для анализа тендеров и предложений поставщиков.

## Важные замечания

1. **Безопасность**: Эндпоинт `/api/reports/**` добавлен в конфигурацию безопасности и доступен для ролей ADMIN, MANAGER и VIEWER.

2. **Перезапуск**: После внесения изменений в конфигурацию безопасности необходимо перезапустить приложение.

3. **Тестирование**: Функционал протестирован и готов к использованию в продакшене.

4. **Исправления**: Исправлена проблема с компиляцией в `CompanyDtoUpdate.java` - удален неиспользуемый импорт `CompanyType`.
