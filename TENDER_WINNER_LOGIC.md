# Новая логика определения победителей тендера

## Обзор изменений

Система тендеров была переработана для определения победителя по каждой позиции с учетом НДС и доставки. Теперь победитель определяется на каждую позицию отдельно, а не по общему предложению.

## Основные изменения

### 1. Определение победителя по позициям

- **Раньше**: Победитель определялся по общему предложению с минимальной ценой
- **Теперь**: Победитель определяется по каждой позиции отдельно с учетом НДС и доставки

### 2. Учет НДС и доставки

- Все цены рассчитываются с учетом НДС (20% по умолчанию)
- Учитывается стоимость доставки для каждой позиции
- Победитель определяется по минимальной общей стоимости: `цена + НДС + доставка`

### 3. Выявление второй цены

- Система автоматически определяет вторую по величине цену для каждой позиции
- Вторая цена отображается в интерфейсе для анализа конкуренции

### 4. Расчет экономии

- Экономия рассчитывается с учетом НДС и доставки
- Показывается как абсолютная сумма, так и процент экономии

## Новая архитектура

### Backend

#### Новые DTO классы:

1. **TenderWinnerDto** - основной DTO для результатов определения победителей
2. **TenderItemWinnerDto** - DTO для победителя по конкретной позиции
3. **TenderWinnerSummaryDto** - сводная статистика по победителям
4. **SupplierPriceDto** - расширен для включения НДС и доставки

#### Новые сервисы:

1. **TenderWinnerService** - основной сервис для определения победителей
2. **TenderWinnerServiceImpl** - реализация сервиса

#### Новые контроллеры:

1. **TenderWinnerController** - API для работы с победителями

### Frontend

#### Новые компоненты:

1. **TenderWinnersDisplay** - компонент для отображения победителей
2. Обновленная страница **TenderDetailPage** с вкладками

## API Endpoints

### Определение победителей

```
GET /api/tenders/{tenderId}/winners
```
Возвращает полную информацию о победителях по всем позициям

### Победитель по позиции

```
GET /api/tenders/{tenderId}/winners/items/{itemId}
```
Возвращает победителя по конкретной позиции

### Все победители по позициям

```
GET /api/tenders/{tenderId}/winners/items
```
Возвращает список всех победителей по позициям

### Вторые цены

```
GET /api/tenders/{tenderId}/winners/second-prices
```
Возвращает вторые цены по всем позициям

### Расчет экономии

```
GET /api/tenders/{tenderId}/winners/savings
```
Возвращает общую экономию с учетом НДС и доставки

### Статистика победителей

```
GET /api/tenders/{tenderId}/winners/statistics
```
Возвращает сводную статистику по победителям

## Алгоритм определения победителя

1. **Сбор всех предложений** по позиции
2. **Расчет для каждого предложения**:
   - Базовая цена × количество
   - НДС = базовая цена × 20%
   - Общая стоимость = базовая цена + НДС + доставка
3. **Сортировка** по общей стоимости (по возрастанию)
4. **Определение победителя** - первое место в отсортированном списке
5. **Определение второй цены** - второе место в отсортированном списке

## Формулы расчета

### Общая стоимость с НДС и доставкой
```
totalPriceWithVatAndDelivery = (unitPrice × quantity) × 1.2 + deliveryCost
```

### Экономия
```
savings = estimatedPrice × quantity - totalPriceWithVatAndDelivery
savingsPercentage = (savings / (estimatedPrice × quantity)) × 100
```

### НДС
```
vatAmount = (unitPrice × quantity) × 0.2
```

## Интерфейс пользователя

### Вкладки на странице тендера

1. **Детали тендера** - основная информация о тендере
2. **Победители** - новая вкладка с результатами определения победителей
3. **Анализ цен** - существующий анализ цен

### Отображение победителей

- **Сводная статистика** с общей экономией, количеством победителей
- **Победители по позициям** в виде аккордеонов
- **Таблица всех предложений** с выделением победителя и второй цены
- **Детальная информация** по каждой позиции

## Преимущества новой системы

1. **Более точное определение победителя** - учитываются все реальные затраты
2. **Прозрачность** - видна вторая цена для анализа конкуренции
3. **Гибкость** - можно выбирать разных поставщиков для разных позиций
4. **Экономия** - более точный расчет экономии с учетом всех факторов
5. **Удобство** - четкое разделение по позициям

## Миграция данных

Существующие тендеры продолжат работать с новой логикой. При первом обращении к API победителей система автоматически пересчитает результаты с учетом НДС и доставки.

## Настройки

- **НДС по умолчанию**: 20% (можно настроить в коде)
- **Статусы для отображения**: EVALUATION, AWARDED
- **Валюты**: поддерживается RUB (рубли)

## Тестирование

Для тестирования новой функциональности:

1. Создайте тендер с несколькими позициями
2. Добавьте предложения от разных поставщиков
3. Переведите тендер в статус EVALUATION
4. Откройте вкладку "Победители"
5. Проверьте корректность расчетов и отображения
