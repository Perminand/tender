# Создание контрактов из тендеров

## Обзор

Функциональность позволяет автоматически создавать контракты на основе выигранных тендеров с автоматическим заполнением всех данных, включая позиции.

## Как это работает

### 1. Предварительные требования

- Тендер должен иметь статус `AWARDED` (присужден)
- Должно существовать принятое предложение поставщика (`ACCEPTED`)
- Поставщик должен быть указан корректно

### 2. Процесс создания контракта

1. **Получение данных тендера**
   - Проверка статуса тендера
   - Получение информации о заказчике
   - Получение всех предложений поставщиков

2. **Поиск принятого предложения**
   - Фильтрация предложений по статусу `ACCEPTED`
   - Проверка соответствия поставщика

3. **Создание контракта**
   - Автоматическое заполнение основных полей
   - Копирование условий из предложения
   - Установка статуса `DRAFT`

4. **Создание позиций контракта**
   - Копирование всех позиций из предложения
   - Сохранение цен, количества, характеристик
   - Связывание с материалами и единицами измерения

### 3. Автоматически заполняемые поля

#### Основные данные контракта:
- `contractNumber` - автоматически генерируется (CON-{timestamp})
- `title` - "Контракт по тендеру {номер_тендера}"
- `tender` - ссылка на исходный тендер
- `supplierProposal` - ссылка на принятое предложение
- `customer` - заказчик из тендера
- `supplier` - поставщик из предложения
- `contractDate` - текущая дата
- `startDate` - текущая дата
- `status` - DRAFT
- `totalAmount` - общая сумма из предложения
- `currency` - валюта из предложения
- `paymentTerms` - условия оплаты из предложения
- `deliveryTerms` - условия поставки из предложения
- `warrantyTerms` - гарантийные условия из предложения

#### Позиции контракта:
- `itemNumber` - номер позиции
- `description` - описание товара/услуги
- `quantity` - количество
- `unit` - единица измерения
- `unitPrice` - цена за единицу
- `totalPrice` - общая стоимость позиции
- `specifications` - технические характеристики
- `deliveryPeriod` - срок поставки
- `warranty` - гарантийные обязательства
- `additionalInfo` - дополнительная информация

## API Endpoints

### Создание контракта из тендера

```http
POST /api/contracts/from-tender?tenderId={tenderId}&supplierId={supplierId}
```

**Параметры:**
- `tenderId` (UUID) - ID тендера
- `supplierId` (UUID) - ID поставщика

**Ответ:**
```json
{
  "id": "uuid",
  "contractNumber": "CON-1234567890",
  "title": "Контракт по тендеру T-001",
  "tenderId": "uuid",
  "supplierId": "uuid",
  "customerId": "uuid",
  "status": "DRAFT",
  "totalAmount": 100000.00,
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "terms": "Условия контракта",
  "description": "Описание контракта"
}
```

## Логирование

Система ведет подробное логирование процесса создания контракта:

- Информация о найденном тендере
- Количество предложений поставщиков
- Детали принятого предложения
- Количество созданных позиций
- Ошибки и предупреждения

## Обработка ошибок

### Возможные ошибки:

1. **"Тендер не найден"** - указанный tenderId не существует
2. **"Контракт можно создать только для присужденного тендера"** - статус тендера не AWARDED
3. **"Принятое предложение поставщика не найдено"** - нет предложения со статусом ACCEPTED
4. **"Поставщик не найден"** - указанный supplierId не существует

### Логирование ошибок:

Все ошибки логируются с подробной информацией:
- ID тендера и поставщика
- Статус тендера
- Количество найденных предложений
- Детали ошибки

## Фронтенд интеграция

### Страница создания контракта

При создании контракта из тендера отображается:

1. **Информация о тендере:**
   - Номер тендера
   - Название
   - Статус
   - Заказчик

2. **Позиции выбранного предложения:**
   - Полная таблица с детализацией
   - Цены в отформатированном виде
   - Дополнительные характеристики
   - Сроки поставки и гарантии

3. **Все предложения поставщиков:**
   - Сравнительная таблица
   - Выделение выбранного поставщика
   - Статусы предложений

### Навигация

Контракт можно создать из:
- Страницы деталей тендера (кнопка "Создать контракт")
- Страницы списка тендеров (кнопка "Заключить контракт")
- Страницы предложений поставщика

## Тестирование

### Unit тесты

Созданы тесты для проверки:
- Корректной загрузки сервисов
- Обработки несуществующих тендеров
- Валидации входных параметров

### Интеграционные тесты

Рекомендуется тестировать:
- Создание контракта с валидными данными
- Обработку различных статусов тендеров
- Корректность копирования позиций
- Валидацию связей между сущностями

## Мониторинг

### Метрики для отслеживания:

- Количество созданных контрактов
- Время выполнения операции
- Количество ошибок по типам
- Среднее количество позиций в контракте

### Алерты:

- Высокое количество ошибок создания контрактов
- Долгое время выполнения операции
- Отсутствие принятых предложений для присужденных тендеров 