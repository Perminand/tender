# Функциональность экспорта анализа цен в Excel

## Обзор

Система теперь поддерживает экспорт анализа цен тендера в Excel формат, аналогично примеру, предоставленному пользователем. Excel отчет содержит детальную информацию о позициях тендера, предложениях поставщиков и сравнительный анализ цен.

## Архитектура

### Backend компоненты

#### 1. Сервис экспорта
```java
PriceAnalysisExportService - интерфейс сервиса экспорта
PriceAnalysisExportServiceImpl - реализация экспорта в Excel
```

#### 2. Контроллер
```java
PriceAnalysisController - содержит endpoint для экспорта
GET /api/price-analysis/tender/{tenderId}/export
```

### Frontend компоненты

#### 1. Компоненты с кнопками экспорта
```typescript
PriceAnalysisSummary - кнопка "Экспорт в Excel"
PriceAnalysisPage - кнопка "Скачать отчёт"
TenderWinnersDisplay - кнопка "Экспорт в Excel"
```

## Структура Excel отчета

### Заголовок отчета
- **Название**: "Тендер по заявке №{номер_заявки}"
- **Заказчик**: Название компании-заказчика
- **Проект**: Название тендера
- **Склад**: Название склада
- **Исполнитель**: "Жданов Ю.Я."
- **Поставщик**: Пустое поле (для заполнения)
- **Комментарий**: Пустое поле (для заполнения)

### Основные колонки
1. **№ п/п** - Порядковый номер позиции
2. **Наименование материала, услуги по Заявке** - Описание из заявки
3. **Кол-во** - Количество из заявки
4. **Ед. изм.** - Единица измерения из заявки
5. **Наименование материала, услуги по Смете** - Описание из сметы
6. **Характеристики материала по Смете** - Спецификации
7. **Кол-во (Смета)** - Количество из сметы
8. **Ед. изм. (Смета)** - Единица измерения из сметы
9. **Сметная цена** - Цена за единицу из сметы
10. **Сметная Стоимость** - Общая стоимость по смете
11. **Ссылка на Материал** - URL ссылка на материал

### Колонки поставщиков (для каждого поставщика)
- **№ Тендера** - Номер тендера поставщика
- **Срок (дней)** - Срок поставки в днях
- **Стоимость с НДС (руб.)** - Цена с учетом НДС

### Итоговая строка
- **Итого**: Общие суммы по смете и предложениям поставщиков

## Функциональность

### 1. Автоматическое создание отчета
```java
// Создание Excel файла с данными тендера
ByteArrayOutputStream exportPriceAnalysisToExcel(UUID tenderId)
```

### 2. Форматирование данных
- **Стили заголовков**: Жирный шрифт, серый фон, границы
- **Стили цен**: Числовой формат с двумя знаками после запятой
- **Стили поставщиков**: Светло-зеленый фон для колонок поставщиков
- **Автоматическая подгонка ширины колонок**

### 3. Расчеты
- **Цена с НДС**: `базовая_цена * (1 + 0.20)` (20% НДС)
- **Общая стоимость**: `цена_за_единицу * количество`
- **Итоговые суммы**: Суммирование по всем позициям

### 4. Обработка данных
- **Извлечение дней из периода**: Парсинг строк типа "30 дней"
- **Поиск предложений**: Сопоставление позиций тендера с предложениями поставщиков
- **Обработка отсутствующих данных**: Заполнение пустыми значениями

## API Endpoints

### Экспорт анализа цен
```
GET /api/price-analysis/tender/{tenderId}/export
```

**Параметры:**
- `tenderId` (UUID) - ID тендера

**Ответ:**
- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- Content-Disposition: `attachment; filename=price-analysis-{tenderId}.xlsx`
- Body: Excel файл в формате .xlsx

## UI/UX особенности

### 1. Кнопки экспорта
- **Расположение**: В заголовках соответствующих разделов
- **Иконка**: FileDownload (иконка скачивания)
- **Текст**: "Экспорт в Excel" или "Скачать отчёт"

### 2. Обработка ошибок
- **Показ уведомлений**: При ошибках экспорта
- **Логирование**: Детальные логи в консоли браузера
- **Graceful degradation**: Продолжение работы при ошибках

### 3. Автоматическое скачивание
- **Создание временной ссылки**: Для скачивания файла
- **Автоматическое удаление**: Временных ресурсов после скачивания
- **Именование файлов**: С включением ID тендера

## Зависимости

### Backend
```xml
<!-- Apache POI для работы с Excel -->
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi</artifactId>
    <version>5.2.3</version>
</dependency>
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi-ooxml</artifactId>
    <version>5.2.3</version>
</dependency>
```

### Frontend
```typescript
// Material-UI иконки
import { FileDownload } from '@mui/icons-material';
```

## Пример использования

### 1. Экспорт из сводки анализа цен
1. Открыть страницу тендера
2. Найти раздел "Анализ цен"
3. Нажать кнопку "Экспорт в Excel"
4. Файл автоматически скачается

### 2. Экспорт из детального анализа
1. Открыть страницу "Анализ цен"
2. Нажать кнопку "Скачать отчёт"
3. Файл автоматически скачается

### 3. Экспорт из раздела победителей
1. Открыть вкладку "Победители" на странице тендера
2. Нажать кнопку "Экспорт в Excel"
3. Файл автоматически скачается

## Преимущества

1. **Стандартизация**: Единый формат отчета для всех тендеров
2. **Детализация**: Полная информация о позициях и предложениях
3. **Сравнительный анализ**: Легкое сравнение цен поставщиков
4. **Автоматизация**: Минимальное участие пользователя
5. **Совместимость**: Стандартный Excel формат
6. **Производительность**: Эффективная генерация больших отчетов

## Ограничения

1. **Размер файла**: Может быть большим для тендеров с множеством позиций
2. **Время генерации**: Зависит от количества позиций и поставщиков
3. **Формат**: Только .xlsx (не поддерживает старый .xls)

## Планы развития

1. **Дополнительные форматы**: Поддержка PDF экспорта
2. **Шаблоны**: Настраиваемые шаблоны отчетов
3. **Фильтрация**: Экспорт только выбранных позиций
4. **Графики**: Добавление диаграмм в Excel отчет
5. **Автоматическая отправка**: Email рассылка отчетов
